/********************************************************
shaman iotas took
copyright January 2013
all rights reserved
completely revamped, february 3, 2013 ~iotas & stentor
updated again february 23, 2013 ~shaman iotas
*/
function start(){postMessage({cmd:"status",msg:"running",stub:stub});while(true){stub.b=(new Date).getTime();stub.dc=stub.c-lastCount;stub.dg=stub.m-lastGemMatch;stub.dt=stub.b-lastTime;stub.d=throttle(stub.dc,stub.dt);var e=diffKey.replace("x",stub.d);var t=new RegExp(e);var n=JSON.stringify(stub);var r=SHA256(n);if(t.test(r)){var i={cmd:"m"};i.rar=0;lastCount=stub.c;lastTime=stub.b;var s=e+itemKey;var o=new RegExp(s);var u=o.exec(r);var a=u.slice(0,u.length);a.push("?");if(a[2].length){i.cmd="c";i.rar=a[2].length;lastGemMatch=stub.m;i.keep=false}else if(a[3].length){i.cmd="r";i.rar=a[3].length;lastGemMatch=stub.m;i.keep=true}i.npoe=a;i.proofs=[lastMatch,stub];i.appdata={};postMessage(i);lastMatch=JSON.parse(JSON.stringify(stub));stub.m++}stub.c++}}function throttle(e,t){var n=3;var r=e||0;var i=t||1;var s=r/i||0;if(s>=0&&s<=4){n=3}else if(s>4&&s<=12){n=4}else if(s>12&&s<=30){n=5}else{n=Math.round(s/3e4)+5}return n}importScripts("/js/SHA256.js");var realm="satoshi";var diffKey="^(0{x})";var itemKey="(0{0,3})(0{0,})([0-9a-f]*)([0-9a-f]{16})([0-9a-f]{16})([0-9a-f]{16})$";var stub={};var b=(new Date).getTime();var started=false;var difficulty=3;var lastMatch={};var lastGemMatch=0;var lastTime=lastCount=0;self.onmessage=function(e){if(e.data.cmd=="start"){if(started){return}diffKey=e.data.diffKey||diffKey;itemKey=e.data.itemKey||itemKey;stub=e.data.stub||{};stub.b=b;stub.c=0;stub.d=difficulty;stub.dc=0;stub.dg=lastGemMatch;stub.dt=0;lastTime=stub.b;if(e.data.loc){stub.loc=e.data.loc}stub.m=0;stub.r=realm;started=true;runFlag=true;start()}};self.postMessage({cmd:"status",msg:"worker initialized"})